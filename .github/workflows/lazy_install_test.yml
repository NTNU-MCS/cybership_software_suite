name: Install & Build via lazy_install.sh (ROS 2 Jazzy, Ubuntu 24.04)

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  ROS_DISTRO: jazzy
  # Keep workspace inside runner home by default; override here if your script supports it
  ROS_WS: ${{ github.workspace }}/ros_ws
  DEBIAN_FRONTEND: noninteractive
  NEEDRESTART_MODE: a
  LANG: en_US.UTF-8

jobs:
  install-and-build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show runner info
        run: |
          uname -a
          cat /etc/os-release
          df -h

      - name: Install ROS 2 Jazzy (CI-safe)
        run: |
          set -euxo pipefail

          # Base tooling + locale
          sudo env DEBIAN_FRONTEND=${DEBIAN_FRONTEND} NEEDRESTART_MODE=${NEEDRESTART_MODE} apt-get update
          sudo env DEBIAN_FRONTEND=${DEBIAN_FRONTEND} NEEDRESTART_MODE=${NEEDRESTART_MODE} apt-get install -y --no-install-recommends \
            ca-certificates curl locales software-properties-common
          sudo locale-gen en_US.UTF-8
          sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
          sudo add-apt-repository -y universe

          # Install ros-apt-source (official new method)
          export ROS_APT_SOURCE_VERSION=$(curl -s https://api.github.com/repos/ros-infrastructure/ros-apt-source/releases/latest \
              | grep -F "tag_name" | awk -F '"' '{print $4}')

          curl -L -o /tmp/ros2-apt-source.deb \
            "https://github.com/ros-infrastructure/ros-apt-source/releases/download/${ROS_APT_SOURCE_VERSION}/ros2-apt-source_${ROS_APT_SOURCE_VERSION}.$(. /etc/os-release && echo ${UBUNTU_CODENAME:-${VERSION_CODENAME}})_all.deb"

          sudo dpkg -i /tmp/ros2-apt-source.deb

          sudo env DEBIAN_FRONTEND=${DEBIAN_FRONTEND} NEEDRESTART_MODE=${NEEDRESTART_MODE} apt-get update

          # Required per ROS docs: upgrade before installing ROS
          sudo env DEBIAN_FRONTEND=${DEBIAN_FRONTEND} NEEDRESTART_MODE=${NEEDRESTART_MODE} apt-get upgrade -y

          # Install ROS 2 Jazzy Desktop
          sudo env DEBIAN_FRONTEND=${DEBIAN_FRONTEND} NEEDRESTART_MODE=${NEEDRESTART_MODE} apt-get install -y ros-jazzy-desktop

          # Development tools (recommended)
          sudo env DEBIAN_FRONTEND=${DEBIAN_FRONTEND} NEEDRESTART_MODE=${NEEDRESTART_MODE} apt-get install -y ros-dev-tools

          # Verify installation
          source /opt/ros/jazzy/setup.bash
          ros2 --version

      - name: Run lazy_install.sh (first pass)
        env:
          ROS_DISTRO: ${{ env.ROS_DISTRO }}
          # If your script respects ROS_WORKSPACE, we direct it to a contained path
          ROS_WORKSPACE: ${{ env.ROS_WS }}
        run: |
          set -euo pipefail
          source /opt/ros/${ROS_DISTRO}/setup.bash
          bash ./lazy_install.sh

      - name: Assert workspace and repo presence
        run: |
          test -d "${ROS_WS}" || (echo "Workspace missing: ${ROS_WS}" >&2; exit 1)
          test -d "${ROS_WS}/src/cybership_software_suite" || (echo "Repo not cloned into workspace." >&2; exit 1)
          echo "Workspace and repository exist"

      - name: Run lazy_install.sh again (idempotency check)
        env:
          ROS_DISTRO: ${{ env.ROS_DISTRO }}
          ROS_WORKSPACE: ${{ env.ROS_WS }}
        run: |
          set -euo pipefail
          source /opt/ros/${ROS_DISTRO}/setup.bash
          bash ./lazy_install.sh
          echo "Second run completed (idempotent)"

      - name: Smoke test the overlay
        env:
          ROS_WORKSPACE: ${{ env.ROS_WS }}
        run: |
          set -euo pipefail
          source "${ROS_WORKSPACE}/venv/bin/activate"
          source "${ROS_WORKSPACE}/install/setup.bash"

          which python
          python -V
          python -c "import rclpy; print('rclpy import OK')"

          which ros2
          ros2 --version

          echo "Listing packages in the overlay (if any were built):"
          colcon list || true
          echo "Environment OK"

      - name: Disk usage snapshot (always)
        if: always()
        run: |
          df -h
          du -h -d1 $HOME | sort -hr | head -n 50

      # Optional caches/artifacts:
      # - name: Cache pip
      #   uses: actions/cache@v4
      #   with:
      #     path: ~/.cache/pip
      #     key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
      #     restore-keys: ${{ runner.os }}-pip-
      #
      # - name: Upload colcon build logs
      #   if: failure()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: colcon-logs
      #     path: ${{ env.ROS_WS }}/log